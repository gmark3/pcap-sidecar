# Deploying a hello world app with pcap-sidecar to Cloud Run

This page describes how to quickly setup a Cloud Run service with the pcap-sidecar to test capturing packets on your container.

## Prerequisites

*   A Google Cloud project with billing enabled.
*   The Google Cloud SDK installed and configured or access to a Cloud Shell terminal.

## Configuration

1.  **Set Environment Variables:**

    You *must* set the following environment variables in your shell before proceeding.  These variables are used throughout the deployment and cleanup processes.

    ```bash
    export PROJECT_ID="your-gcp-project-id" 
    export PCAP_GCS_BUCKET="your-gcs-bucket" 
    export SERVICE_ACCOUNT="your-service-account@your-project.iam.gserviceaccount.com" 

    #below values can be changed as needed       
    export SERVICE_NAME="hello-world-with-sidecar"
    export REGION="us-central1"                 
    ```

    *   `PROJECT_ID`: Your Google Cloud Project ID.  This identifies your GCP project where the Cloud Run service will be deployed.
    *   `PCAP_GCS_BUCKET`: The name of your Google Cloud Storage bucket. This bucket will store the captured PCAP files generated by the sidecar. We will create the bucket, if it doesn't exist, in the later steps.
    *   `SERVICE_ACCOUNT`: The service account that your Cloud Run service will use. This account needs appropriate permissions (at least `roles/storage.admin` on the `PCAP_GCS_BUCKET`) to access the GCS bucket.
    *   `SERVICE_NAME`: The name you want to give your Cloud Run service. This can be customized.
    *   `REGION`: The Google Cloud region where you want to deploy your Cloud Run service.  `us-central1` is a suggested region, but you can choose another.


1.  **Create a GCS bucket** to store the captured network traffic.

    Configure Cloud Storage Bucket for PCAP file upload. Give the runtime service account the `roles/storage.admin` role on the bucket so that it may create objects and read bucket metadata.

    If the bucket doesn't exist, create it first using:
    
    ```bash
    gcloud storage buckets create "$PCAP_GCS_BUCKET" -location=$REGION  --project="$PROJECT_ID"
    ```

    This step ensures your service account has the correct permissions.

    ```bash
    gcloud storage buckets grant-acl "roles/storage.admin" "$SERVICE_ACCOUNT" --bucket="$PCAP_GCS_BUCKET" --project="$PROJECT_ID"
    ```

4. **Review [cloudrun.yaml](cloudrun.yaml) (Optional)**

    The `cloudrun.yaml` file is a template containing placeholders for the environment variables.

 
5.  **Review [prepare_and_dry-run.sh](prepare_and_dry-run.sh) (Optional)**

    The script takes environment variables to create a `service.yaml` file. The generated `service.yaml` is then used in a dry-run test and outputs the gcloud command to apply the configuration.


## Deployment

1.  **Run the preparation and dry-run script:**

    ```bash
    ./prepare_and_dry-run.sh
    ```

    This script will:

    *   Create a `service.yaml` file by substituting the environment variables into `cloudrun.yaml`.


2.  **Verify the generated service.yaml:**

    Thoroughly examine the generated `service.yaml` output from the dry-run.  Make sure the service name, environment variables, region, and other settings are correct.  If anything is wrong, adjust the environment variables and re-run `prepare_and_dry-run.sh` to overwrite the `service.yaml` file.

3.  **Deploy the Service:**

    Copy and paste the `gcloud run services replace` command that was printed by the script and run it.  For example:
    
    `gcloud run services replace service.yaml --project="your-gcp-project-id" --region="us-central1"`
    

## Accessing the Service

Once deployed, you can access the service at the URL provided by Cloud Run or the `curl` command output by the script. **Since the service requires authentication, you will need to use an authenticated request.**

Example command to access the service using curl and gcloud:

```bash
curl -H "Authorization: Bearer $(gcloud auth print-identity-token)" $(gcloud run services describe "$SERVICE_NAME" --project "$PROJECT_ID" --region "$REGION" --format='value(status.url)')
```

## Clean Up

**Important:** Always double-check your commands before executing them, especially those that delete resources. The gcloud commands below assume that the environment variables PROJECT_ID, SERVICE_NAME, REGION, PCAP_GCS_BUCKET, and SERVICE_ACCOUNT are correctly set.

```bash
#print the variables to confirm they are correct
echo "Variables for Clean Up:"
printf "%-20s: %s\n" "PROJECT_ID" "$PROJECT_ID"
printf "%-20s: %s\n" "SERVICE_NAME" "$SERVICE_NAME"
printf "%-20s: %s\n" "REGION" "$REGION"
printf "%-20s: %s\n" "PCAP_GCS_BUCKET" "$PCAP_GCS_BUCKET"
printf "%-20s: %s\n" "SERVICE_ACCOUNT" "$SERVICE_ACCOUNT"

echo ""
echo "Review these variables carefully before proceeding with the cleanup."
```

1. **Delete the Cloud Run service:**

   ```bash
   gcloud run services delete $SERVICE_NAME --project="$PROJECT_ID" --region="$REGION"
   ```

2. **Delete PCAP files from the Cloud Storage bucket:**

   **If you will delete the bucket, you can skip this step**
   ```bash
   gcloud storage rm -r gs://$PCAP_GCS_BUCKET/pcap/*
   ```

   This removes all files and folders. Use caution; this action is irreversible.

3. **Revoke storage permissions from the service account:**

   ```bash
   gcloud storage buckets remove-acl "roles/storage.admin" "$SERVICE_ACCOUNT" --bucket="$PCAP_GCS_BUCKET" --project="$PROJECT_ID"
   ```

4. **Delete the Cloud Storage bucket:**

   If the GCS bucket was created solely for this deployment, delete it:

   **Warning:** This permanently deletes the bucket and all its contents. 

   ```bash
   gcloud storage buckets delete "$PCAP_GCS_BUCKET" --project="$PROJECT_ID"
   ```